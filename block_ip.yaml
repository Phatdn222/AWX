- name: Manage UFW rules
  hosts: 192.168.3.160
  gather_facts: false
  become: yes
  become_method: sudo
  become_user: root
  tasks:
    - name: Debug raw input
      debug:
        msg: "Raw ip_address input: {{ ip_address | default('empty') }}"
      delegate_to: 192.168.3.160

    - name: Extract IP from observable
      set_fact:
        ip_address: "{{ (ip_address | from_json).data | default(ip_address) if ip_address is string and ip_address | length > 0 and (ip_address | from_json is success) else ip_address | default('') }}"
      delegate_to: 192.168.3.160

    - name: Debug extracted IP
      debug:
        msg: "IP address to block: {{ ip_address }}"
      when: ip_address | length > 0
      delegate_to: 192.168.3.160

    - name: Block IP using UFW
      ufw:
        rule: deny
        from_ip: "{{ ip_address }}"
      when: ip_address | length > 0
      delegate_to: 192.168.3.160
